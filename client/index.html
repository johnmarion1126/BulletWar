<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <title>Run And Shoot</title>
</head>
<body>
    <div id="sign-div">
        Username: <input id="sign-div-username" type="text"><br>
        <button id="sign-div-enter">Enter</button>
    </div>

    <div id="game-div">
        <canvas id="ctx" width="500" height="500"></canvas>
        <div id="chat-text">
            <div>Hello!</div>
        </div>

        <form id="chat-form">
            <input id="chat-input" type="text">
        </form>
    </div>

    <script>

        const socket = io();

        // Sign In
        const signDiv = document.getElementById('sign-div');
        const signDivUsername = document.getElementById('sign-div-username');
        const signDivEnter = document.getElementById('sign-div-enter');
        const gameDiv = document.getElementById('game-div');

        signDivEnter.onclick = () => {
            socket.emit('signIn', { username: signDivUsername.value });
        }

        socket.on('signInResponse', () => {
            signDiv.style.display = 'none';
            gameDiv.style.display = 'inline-block';
        })

        // Chat
        const chatText = document.getElementById('chat-text');
        const chatInput = document.getElementById('chat-input');
        const chatForm = document.getElementById('chat-form');

        socket.on('addToChat', (data) => {
            chatText.innerHTML += '<div>' + data + '</div>';
        });

        chatForm.onsubmit = (e) => {
            e.preventDefault();
            socket.emit('sendMsgToServer', chatInput.value);
            chatInput.value = '';
        }

        // Game
        const ctx = document.getElementById("ctx").getContext("2d");
        ctx.font = '30px Arial';

        const playerList = {};
        const bulletList = {};

        // TODO:
        // ADD player instances to playerList
        class Player {
            constructor(initPack) {
                this.id = initPack.id;
                this.number = initPack.number;
                this.x = initPack.x;
                this.y = initPack.y;
                this.hp = initPack.hp;
                this.hpMax = initPack.hpMax;
                this.score = initPack.score;
            }

            draw() {
                const hpWidth = 30 * this.hp / this.hpMax;
                ctx.fillRect(this.x - hpWidth / 2, this.y - 40, hpWidth, 4);
                ctx.fillText(this.number, this.x, this.y);
                ctx.fillText(this.score, this.x, this.y - 60);
            }
        }

        // TODO:
        // ADD bullet instances to bulletList
        class Bullet {
            constructor() {
                this.id = initPack.id;
                this.x = initPack.x;
                this.y = initPack.y;
            }

            draw() {
                ctx.fillRect(this.x - 5, this.y - 5, 10, 10);
            }
        }

        socket.on('init', (data) => {
            for (let i = 0; i < data.player.length; i += 1) {
                const player = new Player(data.player[i]);
                playerList[player.id] = player;
            }
            for (let i = 0; i < data.bullet.length; i += 1) {
                const bullet = new Bullet(data.bullet[i]);
                bulletList[bullet.id] = bullet;
            }
        });

        socket.on('update', (data) => {
            for (let i = 0; i < data.player.length; i += 1) {
                const pack = data.player[i];
                const p = playerList[pack.id];
                if (p) {
                    if(pack.x !== undefined)
                        p.x = pack.x;
                    if(pack.y !== undefined)
                        p.y = pack.y;
                    if(pack.hp !== undefined)
                        p.hp = pack.hp;
                    if(pack.score !== undefined)
                        p.score = pack.score;
                }
            }
            for (let i = 0; i < data.bullet.length; i += 1) {
                const pack = data.bullet[i];
                const b = bulletList[data.bullet[i].id];
                if (b) {
                    if(pack.x !== undefined)
                        b.x = pack.x;
                    if(pack.y !== undefined)
                        b.y = pack.y;
                }
            }
        });

        socket.on('remove', (data) => {
            for (let i = 0; i < data.player.length; i += 1) {
                delete playerList[data.player[i]];
            }
            for (let i = 0; i < data.bullet.length; i += 1) {
                delete bulletList[data.bullet[i]];
            }
        })

        setInterval(() => {
            ctx.clearRect(0, 0, 500, 500);
            for (let i in playerList) playerList[i].draw();
            for (let i in bulletList) bulletList[i].draw();
        }, 40);

        document.onkeydown = (event) => {
            if(event.keyCode === 68)	
			    socket.emit('keyPress', { inputId: 'right', state: true });
		    else if(event.keyCode === 83)	
			    socket.emit('keyPress', { inputId: 'down', state: true });
		    else if(event.keyCode === 65) 
			    socket.emit('keyPress', { inputId: 'left', state: true });
		    else if(event.keyCode === 87) 
			    socket.emit('keyPress', { inputId: 'up', state: true });
        };

        document.onmousedown = (event) => {
            socket.emit('keyPress', { inputId: 'attack', state: true });
        };

        document.onmouseup = (event) => {
            socket.emit('keyPress', { inputId: 'attack', state: false });
        };

        document.onmousemove = (event) => {
            const x = -250 + event.clientX - 8;
            const y = -250 + event.clientY - 8;
            const angle = Math.atan2(y, x) / Math.PI * 180;
            socket.emit('keyPress', { inputId: 'mouseAngle', state: angle });
        };

    </script>
</body>
</html>